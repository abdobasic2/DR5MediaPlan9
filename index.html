<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">DR5 Marketing Plan Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f4f8;
            color: #1a202c;
            line-height: 1.6;
            transition: all 0.3s ease;
        }
        body[lang="ar"] {
            direction: rtl;
            text-align: right;
        }
        .container {
            max-width: 1280px;
        }
        .bg-custom-gradient {
            background-image: linear-gradient(to right top, #0077b6, #00b4d8);
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        .input-group input, .input-group select {
            border: 2px solid #e2e8f0;
            transition: border-color 0.3s ease;
        }
        .input-group input:focus, .input-group select:focus {
            border-color: #0077b6;
            box-shadow: 0 0 0 3px rgba(0, 119, 182, 0.2);
        }
        .accordion-button {
            transition: background-color 0.3s ease;
        }
        .accordion-button:hover {
            background-color: #e2e8f0;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.95, 0.05, 0.795, 0.755);
        }
        .accordion-content.open {
            max-height: 2000px;
            padding-bottom: 2rem;
            transition: max-height 1s cubic-bezier(0.95, 0.05, 0.795, 0.755);
        }
        .btn-primary {
            background-color: #0077b6;
            color: white;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #005f99;
            transform: scale(1.02);
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 150%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .hidden-content {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Header Section -->
    <header class="bg-custom-gradient text-white text-center py-20 shadow-lg">
        <div class="container mx-auto px-6 flex flex-col md:flex-row justify-between items-center">
            <div class="flex flex-col md:flex-row items-center">
                <h1 class="text-4xl md:text-5xl font-extrabold mb-2 md:mb-0" data-lang-key="header.title">
                    DR5 Marketing Plan Dashboard
                </h1>
                <p class="text-lg md:text-xl font-light md:mr-4" data-lang-key="header.subtitle">
                    Interactive Plan Management
                </p>
            </div>
            <button id="langToggleBtn" class="mt-4 md:mt-0 px-4 py-2 bg-white text-blue-600 rounded-full font-bold shadow-md hover:bg-gray-200 transition-colors duration-300">
                العربية
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-12 space-y-12">

        <!-- KPIs & Financial Overview -->
        <section>
            <h2 class="text-3xl font-bold mb-8 text-center" data-lang-key="kpis.title">Key Performance Indicators</h2>
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="card p-6 text-center">
                    <h3 class="text-lg font-bold text-gray-700" data-lang-key="kpis.totalBudget">Total Budget</h3>
                    <p class="text-4xl font-extrabold text-blue-600 mt-2" id="totalBudgetDisplay">250,000 EGP</p>
                </div>
                <div class="card p-6 text-center">
                    <h3 class="text-lg font-bold text-gray-700" data-lang-key="kpis.cpl">Cost Per Lead (CPL)</h3>
                    <p class="text-4xl font-extrabold text-green-600 mt-2" id="cplDisplay">650 EGP</p>
                </div>
                <div class="card p-6 text-center">
                    <h3 class="text-lg font-bold text-gray-700" data-lang-key="kpis.leads">Expected Leads</h3>
                    <p class="text-4xl font-extrabold text-purple-600 mt-2" id="expectedLeadsDisplay">384</p>
                </div>
                <div class="card p-6 text-center">
                    <h3 class="text-lg font-bold text-gray-700" data-lang-key="kpis.conversionRate">Conversion Rate (CR)</h3>
                    <p class="text-4xl font-extrabold text-red-600 mt-2" id="conversionRateDisplay">5%</p>
                </div>
            </div>
        </section>

        <!-- Dynamic Calculator & Charts Section -->
        <section class="grid lg:grid-cols-2 gap-12 items-start">
            <div class="card p-8">
                <h2 class="text-3xl font-bold mb-6 text-gray-800" data-lang-key="calculator.title">Dynamic Plan Calculator</h2>
                <div class="space-y-6">
                    <div class="input-group">
                        <label for="inputBudget" class="block text-gray-600 font-semibold mb-2" data-lang-key="calculator.labelBudget">Adjust Total Budget (EGP):</label>
                        <input type="number" id="inputBudget" value="250000" min="1000" step="1000" class="w-full p-3 rounded-lg border-2 focus:outline-none">
                    </div>
                    <div class="input-group">
                        <label for="inputLeads" class="block text-gray-600 font-semibold mb-2" data-lang-key="calculator.labelLeads">Target Leads:</label>
                        <input type="number" id="inputLeads" placeholder="Enter target number of leads" min="1" class="w-full p-3 rounded-lg border-2 focus:outline-none">
                    </div>
                    <div class="input-group">
                        <label for="inputCPL" class="block text-gray-600 font-semibold mb-2" data-lang-key="calculator.labelCPL">Average Cost Per Lead (EGP):</label>
                        <input type="number" id="inputCPL" value="650" min="10" step="10" class="w-full p-3 rounded-lg border-2 focus:outline-none">
                    </div>
                    <button id="calculateBtn" class="btn-primary w-full py-3 rounded-lg text-lg font-bold" data-lang-key="calculator.buttonCalculate">
                        Calculate Distribution
                    </button>
                </div>
            </div>

            <div class="card p-8">
                <h2 class="text-3xl font-bold mb-6 text-gray-800" data-lang-key="chart.title">Budget Distribution (Pie Chart)</h2>
                <div class="relative h-96">
                    <canvas id="budgetChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Detailed Plan Breakdown (Accordion) -->
        <section>
            <h2 class="text-3xl font-bold text-center mb-8 text-gray-800" data-lang-key="plan.title">Detailed Plan Breakdown</h2>
            <div class="space-y-4">
                <!-- SMM Section -->
                <div class="card">
                    <button class="accordion-button w-full text-right p-6 text-2xl font-bold text-gray-800 rounded-lg flex items-center justify-between" onclick="toggleAccordion('smmContent')">
                        <span data-lang-key="plan.smm.title">Social Media Marketing (SMM)</span>
                        <svg class="w-6 h-6 transform transition-transform duration-300" id="smmArrow" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div id="smmContent" class="accordion-content">
                        <div class="p-6 border-t border-gray-200">
                            <p class="text-lg text-gray-600 mb-4">
                                <span class="font-bold" data-lang-key="plan.smm.allocatedBudget">Allocated Budget:</span> <span id="smmBudget">200,000 EGP</span> (<span id="smmPercentage">80</span>%)
                            </p>
                            
                            <h4 class="font-bold text-xl text-gray-700 mb-2" data-lang-key="plan.smm.campaignsTitle">Lead Generation Campaigns:</h4>
                            <p class="text-gray-600 mb-4">
                                <span class="font-bold" data-lang-key="plan.smm.campaignsBudget">Budget:</span> <span id="leadsBudget">166,000 EGP</span> (<span id="leadsPercentage">83</span>%)
                            </p>
                            <ul class="list-disc list-inside mt-2 text-sm text-gray-500 space-y-1">
                                <li><span data-lang-key="plan.smm.leadForms">Lead Forms Ads:</span> <span id="leadFormsBudget">100,000 EGP</span></li>
                                <li><span data-lang-key="plan.smm.whatsapp">WhatsApp Click to Message:</span> <span id="whatsappBudget">50,000 EGP</span></li>
                                <li><span data-lang-key="plan.smm.retargeting">Retargeting:</span> <span id="retargetingBudget">16,000 EGP</span></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- SEM Section -->
                <div class="card">
                    <button class="accordion-button w-full text-right p-6 text-2xl font-bold text-gray-800 rounded-lg flex items-center justify-between" onclick="toggleAccordion('semContent')">
                        <span data-lang-key="plan.sem.title">Search Engine Marketing (SEM)</span>
                        <svg class="w-6 h-6 transform transition-transform duration-300" id="semArrow" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div id="semContent" class="accordion-content">
                        <div class="p-6 border-t border-gray-200">
                            <p class="text-lg text-gray-600 mb-4">
                                <span class="font-bold" data-lang-key="plan.sem.allocatedBudget">Allocated Budget:</span> <span id="semBudget">50,000 EGP</span> (<span id="semPercentage">20</span>%)
                            </p>
                            <h4 class="font-bold text-xl text-gray-700 mb-2" data-lang-key="plan.sem.campaignsTitle">Campaign Types:</h4>
                            <ul class="list-disc list-inside text-gray-500 space-y-1">
                                <li><span data-lang-key="plan.sem.googleSearch">Google Search Ads:</span> <span id="googleSearchBudget">35,000 EGP</span></li>
                                <li><span data-lang-key="plan.sem.googleDisplay">Google Display Network / YouTube:</span> <span id="googleDisplayBudget">15,000 EGP</span></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Weekly Plan Section (Accordion) -->
                <div class="card">
                    <button class="accordion-button w-full text-right p-6 text-2xl font-bold text-gray-800 rounded-lg flex items-center justify-between" onclick="toggleAccordion('weeklyPlanContent')">
                        <span data-lang-key="plan.weekly.title">Weekly Plan Breakdown</span>
                        <svg class="w-6 h-6 transform transition-transform duration-300" id="weeklyArrow" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div id="weeklyPlanContent" class="accordion-content">
                        <div class="p-6 border-t border-gray-200">
                            <!-- Week 1 -->
                            <h4 class="font-bold text-xl text-gray-700 mb-4" data-lang-key="plan.weekly.week1.title">Week 1: Initial Launch (Budget: 80,000 EGP)</h4>
                            <div class="grid md:grid-cols-2 gap-6 mb-8">
                                <div class="p-4 bg-gray-100 rounded-lg">
                                    <h5 class="font-bold text-lg text-blue-700" data-lang-key="plan.weekly.week1.metaAds">Meta Ads (Facebook & Instagram)</h5>
                                    <p data-lang-key="plan.weekly.week1.metaBudget">Budget: 55,000 EGP (70%)</p>
                                    <ul class="list-disc list-inside text-sm text-gray-500 mt-2">
                                        <li data-lang-key="plan.weekly.week1.leadGen">Lead Generation: 44,000 EGP</li>
                                        <li data-lang-key="plan.weekly.week1.engagement">Engagement & Awareness: 11,000 EGP</li>
                                        <li data-lang-key="plan.weekly.week1.dailySpend">Daily Spend: ~6,300 EGP</li>
                                    </ul>
                                </div>
                                <div class="p-4 bg-gray-100 rounded-lg">
                                    <h5 class="font-bold text-lg text-blue-700" data-lang-key="plan.weekly.week1.googleAds">Google Ads</h5>
                                    <p data-lang-key="plan.weekly.week1.googleBudget">Budget: 25,000 EGP (30%)</p>
                                    <ul class="list-disc list-inside text-sm text-gray-500 mt-2">
                                        <li data-lang-key="plan.weekly.week1.searchAds">Search Ads: 20,000 EGP</li>
                                        <li data-lang-key="plan.weekly.week1.ytDisplay">YouTube / Display: 5,000 EGP</li>
                                        <li data-lang-key="plan.weekly.week1.dailySpendGoogle">Daily Spend: ~2,850 EGP</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- Week 2-4 content placeholder -->
                            <h4 class="font-bold text-xl text-gray-700 mb-4" data-lang-key="plan.weekly.weeks2-4.title">Weeks 2-4: Continued Strategy</h4>
                            <p class="text-gray-600" data-lang-key="plan.weekly.weeks2-4.description">
                                The plan for weeks 2-4 will be dynamically adjusted based on the performance of the first week's campaigns, focusing on optimizing high-performing channels and keywords.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white text-center py-6 mt-12">
        <p data-lang-key="footer.copyright">&copy; 2024 DR5 Marketing Plan Dashboard. All rights reserved.</p>
    </footer>

    <!-- JavaScript for Interactivity and Charts -->
    <script>
        // Constants for the plan's budget allocation percentages
        const BUDGET_ALLOCATION = {
            SMM: 0.80,
            SEM: 0.20,
            SMM_LEADS: 0.83,
            SMM_AWARENESS: 0.10,
            SMM_ENGAGEMENT: 0.07,
            LEAD_FORMS: 0.60,
            WHATSAPP: 0.30,
            RETARGETING: 0.10,
            SEM_SEARCH: 0.70,
            SEM_DISPLAY: 0.30,
        };

        // Translations object with a language key for each text element
        const translations = {
            'en': {
                'pageTitle': 'DR5 Marketing Plan Dashboard',
                'header.title': 'DR5 Marketing Plan Dashboard',
                'header.subtitle': 'Interactive Plan Management',
                'kpis.title': 'Key Performance Indicators',
                'kpis.totalBudget': 'Total Budget',
                'kpis.cpl': 'Cost Per Lead (CPL)',
                'kpis.leads': 'Expected Leads',
                'kpis.conversionRate': 'Conversion Rate (CR)',
                'calculator.title': 'Dynamic Plan Calculator',
                'calculator.labelBudget': 'Adjust Total Budget (EGP):',
                'calculator.labelLeads': 'Target Leads:',
                'calculator.placeholderLeads': 'Enter target number of leads',
                'calculator.labelCPL': 'Average Cost Per Lead (EGP):',
                'calculator.buttonCalculate': 'Calculate Distribution',
                'chart.title': 'Budget Distribution (Pie Chart)',
                'plan.title': 'Detailed Plan Breakdown',
                'plan.smm.title': 'Social Media Marketing (SMM)',
                'plan.smm.allocatedBudget': 'Allocated Budget:',
                'plan.smm.campaignsTitle': 'Lead Generation Campaigns:',
                'plan.smm.campaignsBudget': 'Budget:',
                'plan.smm.leadForms': 'Lead Forms Ads:',
                'plan.smm.whatsapp': 'WhatsApp Click to Message:',
                'plan.smm.retargeting': 'Retargeting:',
                'plan.sem.title': 'Search Engine Marketing (SEM)',
                'plan.sem.allocatedBudget': 'Allocated Budget:',
                'plan.sem.campaignsTitle': 'Campaign Types:',
                'plan.sem.googleSearch': 'Google Search Ads:',
                'plan.sem.googleDisplay': 'Google Display Network / YouTube:',
                'plan.weekly.title': 'Weekly Plan Breakdown',
                'plan.weekly.week1.title': 'Week 1: Initial Launch (Budget: 80,000 EGP)',
                'plan.weekly.week1.metaAds': 'Meta Ads (Facebook & Instagram)',
                'plan.weekly.week1.metaBudget': 'Budget: 55,000 EGP (70%)',
                'plan.weekly.week1.leadGen': 'Lead Generation: 44,000 EGP',
                'plan.weekly.week1.engagement': 'Engagement & Awareness: 11,000 EGP',
                'plan.weekly.week1.dailySpend': 'Daily Spend: ~6,300 EGP',
                'plan.weekly.week1.googleAds': 'Google Ads',
                'plan.weekly.week1.googleBudget': 'Budget: 25,000 EGP (30%)',
                'plan.weekly.week1.searchAds': 'Search Ads: 20,000 EGP',
                'plan.weekly.week1.ytDisplay': 'YouTube / Display: 5,000 EGP',
                'plan.weekly.week1.dailySpendGoogle': 'Daily Spend: ~2,850 EGP',
                'plan.weekly.weeks2-4.title': 'Weeks 2-4: Continued Strategy',
                'plan.weekly.weeks2-4.description': 'The plan for weeks 2-4 will be dynamically adjusted based on the performance of the first week\'s campaigns, focusing on optimizing high-performing channels and keywords.',
                'footer.copyright': '© 2024 DR5 Marketing Plan Dashboard. All rights reserved.',
            },
            'ar': {
                'pageTitle': 'لوحة تحكم خطة التمويل المباشر',
                'header.title': 'لوحة تحكم خطة DR5',
                'header.subtitle': 'إدارة ومتابعة أداء الخطة التفاعلية',
                'kpis.title': 'مؤشرات الأداء الرئيسية',
                'kpis.totalBudget': 'الميزانية الإجمالية',
                'kpis.cpl': 'تكلفة العميل (CPL)',
                'kpis.leads': 'العملاء المحتملون المتوقعون',
                'kpis.conversionRate': 'نسبة التحويل (CR)',
                'calculator.title': 'حاسبة الخطة الديناميكية',
                'calculator.labelBudget': 'تعديل الميزانية الإجمالية (ج.م):',
                'calculator.labelLeads': 'العملاء المحتملون المستهدفون:',
                'calculator.placeholderLeads': 'أدخل العدد المستهدف من العملاء',
                'calculator.labelCPL': 'متوسط تكلفة العميل (ج.م):',
                'calculator.buttonCalculate': 'احسب التوزيع',
                'chart.title': 'توزيع الميزانية (رسم بياني)',
                'plan.title': 'تفاصيل الخطة',
                'plan.smm.title': 'التسويق عبر وسائل التواصل الاجتماعي (SMM)',
                'plan.smm.allocatedBudget': 'الميزانية المخصصة:',
                'plan.smm.campaignsTitle': 'حملات توليد العملاء المحتملين:',
                'plan.smm.campaignsBudget': 'الميزانية:',
                'plan.smm.leadForms': 'حملات Lead Forms:',
                'plan.smm.whatsapp': 'حملات WhatsApp Click to Message:',
                'plan.smm.retargeting': 'إعادة استهداف العملاء:',
                'plan.sem.title': 'التسويق عبر محركات البحث (SEM)',
                'plan.sem.allocatedBudget': 'الميزانية المخصصة:',
                'plan.sem.campaignsTitle': 'أنواع الحملات:',
                'plan.sem.googleSearch': 'حملات Google Search Ads:',
                'plan.sem.googleDisplay': 'Google Display Network / YouTube:',
                'plan.weekly.title': 'توزيع الخطة الأسبوعي',
                'plan.weekly.week1.title': 'الأسبوع الأول: الإطلاق الأولي (ميزانية: 80,000 ج.م)',
                'plan.weekly.week1.metaAds': 'إعلانات Meta (فيسبوك وإنستجرام)',
                'plan.weekly.week1.metaBudget': 'الميزانية: 55,000 ج.م (70%)',
                'plan.weekly.week1.leadGen': 'توليد العملاء: 44,000 ج.م',
                'plan.weekly.week1.engagement': 'التفاعل والتوعية: 11,000 ج.م',
                'plan.weekly.week1.dailySpend': 'الإنفاق اليومي: ~6,300 ج.م',
                'plan.weekly.week1.googleAds': 'إعلانات Google Ads',
                'plan.weekly.week1.googleBudget': 'الميزانية: 25,000 ج.م (30%)',
                'plan.weekly.week1.searchAds': 'إعلانات البحث: 20,000 ج.م',
                'plan.weekly.week1.ytDisplay': 'يوتيوب / شبكة العرض: 5,000 ج.م',
                'plan.weekly.week1.dailySpendGoogle': 'الإنفاق اليومي: ~2,850 ج.م',
                'plan.weekly.weeks2-4.title': 'الأسابيع 2-4: استراتيجية مستمرة',
                'plan.weekly.weeks2-4.description': 'سيتم تعديل خطة الأسابيع 2-4 ديناميكيًا بناءً على أداء حملات الأسبوع الأول، مع التركيز على تحسين القنوات والكلمات المفتاحية ذات الأداء العالي.',
                'footer.copyright': '© 2024 لوحة تحكم خطة التمويل المباشر لمشروع DR5. جميع الحقوق محفوظة.',
            }
        };

        // Data model and state management
        const state = {
            currentLanguage: 'en',
            planData: {
                totalBudget: 250000,
                cpl: 650,
                conversionRate: 0.05, // 5%
            },
        };

        // DOM element references
        const totalBudgetDisplay = document.getElementById('totalBudgetDisplay');
        const cplDisplay = document.getElementById('cplDisplay');
        const expectedLeadsDisplay = document.getElementById('expectedLeadsDisplay');
        const conversionRateDisplay = document.getElementById('conversionRateDisplay');
        const inputBudget = document.getElementById('inputBudget');
        const inputLeads = document.getElementById('inputLeads');
        const inputCPL = document.getElementById('inputCPL');
        const calculateBtn = document.getElementById('calculateBtn');
        const langToggleBtn = document.getElementById('langToggleBtn');

        // Accordion element references
        const accordionButtons = document.querySelectorAll('.accordion-button');
        const accordionArrows = document.querySelectorAll('.accordion-button svg');

        // Chart.js setup
        let budgetChart;
        const ctx = document.getElementById('budgetChart').getContext('2d');

        /**
         * Initializes the pie chart with the current budget data.
         * @param {number} smmBudget - The budget for Social Media Marketing.
         * @param {number} semBudget - The budget for Search Engine Marketing.
         */
        function initializeChart(smmBudget, semBudget) {
            if (budgetChart) {
                budgetChart.destroy();
            }
            budgetChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: [
                        translations[state.currentLanguage]['plan.smm.title'], 
                        translations[state.currentLanguage]['plan.sem.title']
                    ],
                    datasets: [{
                        data: [smmBudget, semBudget],
                        backgroundColor: ['#0077b6', '#00c6ff'],
                        hoverOffset: 8,
                        borderRadius: 10,
                        spacing: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 14,
                                    family: 'Cairo, sans-serif'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                    const percentage = ((value / total) * 100).toFixed(1) + '%';
                                    return `${label}: ${value.toLocaleString()} EGP (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Calculates all plan values based on the current state.
         */
        function calculatePlan() {
            const { totalBudget, cpl } = state.planData;

            // Calculate expected leads
            const expectedLeads = totalBudget / cpl;

            // Calculate budget allocations
            const smmBudget = totalBudget * BUDGET_ALLOCATION.SMM;
            const semBudget = totalBudget * BUDGET_ALLOCATION.SEM;
            
            // SMM breakdown
            const leadsBudget = smmBudget * BUDGET_ALLOCATION.SMM_LEADS;
            const leadFormsBudget = leadsBudget * BUDGET_ALLOCATION.LEAD_FORMS;
            const whatsappBudget = leadsBudget * BUDGET_ALLOCATION.WHATSAPP;
            const retargetingBudget = leadsBudget * BUDGET_ALLOCATION.RETARGETING;

            // SEM breakdown
            const googleSearchBudget = semBudget * BUDGET_ALLOCATION.SEM_SEARCH;
            const googleDisplayBudget = semBudget * BUDGET_ALLOCATION.SEM_DISPLAY;

            // Update state with calculated values
            state.planData = {
                ...state.planData,
                expectedLeads,
                smmBudget,
                semBudget,
                leadsBudget,
                leadFormsBudget,
                whatsappBudget,
                retargetingBudget,
                googleSearchBudget,
                googleDisplayBudget
            };
        }

        /**
         * Renders all UI elements based on the current state.
         */
        function renderUI() {
            // Update language-specific text
            document.body.setAttribute('lang', state.currentLanguage);
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                el.textContent = translations[state.currentLanguage][key];
            });
            langToggleBtn.textContent = state.currentLanguage === 'en' ? 'العربية' : 'English';
            inputLeads.placeholder = translations[state.currentLanguage]['calculator.placeholderLeads'];

            // Update dynamic numbers and values
            const { totalBudget, cpl, expectedLeads } = state.planData;
            totalBudgetDisplay.textContent = `${totalBudget.toLocaleString()} EGP`;
            cplDisplay.textContent = `${cpl.toLocaleString()} EGP`;
            expectedLeadsDisplay.textContent = Math.round(expectedLeads).toLocaleString();
            conversionRateDisplay.textContent = `${(state.planData.conversionRate * 100).toFixed(0)}%`;

            // Update budget breakdown
            document.getElementById('smmBudget').textContent = `${state.planData.smmBudget.toLocaleString()} EGP`;
            document.getElementById('smmPercentage').textContent = `${(BUDGET_ALLOCATION.SMM * 100).toFixed(0)}`;
            
            document.getElementById('leadsBudget').textContent = `${state.planData.leadsBudget.toLocaleString()} EGP`;
            document.getElementById('leadsPercentage').textContent = `${(BUDGET_ALLOCATION.SMM_LEADS * 100).toFixed(0)}`;
            
            document.getElementById('leadFormsBudget').textContent = `${state.planData.leadFormsBudget.toLocaleString()} EGP`;
            document.getElementById('whatsappBudget').textContent = `${state.planData.whatsappBudget.toLocaleString()} EGP`;
            document.getElementById('retargetingBudget').textContent = `${state.planData.retargetingBudget.toLocaleString()} EGP`;
            
            document.getElementById('semBudget').textContent = `${state.planData.semBudget.toLocaleString()} EGP`;
            document.getElementById('semPercentage').textContent = `${(BUDGET_ALLOCATION.SEM * 100).toFixed(0)}`;
            
            document.getElementById('googleSearchBudget').textContent = `${state.planData.googleSearchBudget.toLocaleString()} EGP`;
            document.getElementById('googleDisplayBudget').textContent = `${state.planData.googleDisplayBudget.toLocaleString()} EGP`;
            
            // Update the chart
            if (budgetChart) {
                budgetChart.data.datasets[0].data = [state.planData.smmBudget, state.planData.semBudget];
                budgetChart.data.labels = [
                    translations[state.currentLanguage]['plan.smm.title'], 
                    translations[state.currentLanguage]['plan.sem.title']
                ];
                budgetChart.update();
            } else {
                initializeChart(state.planData.smmBudget, state.planData.semBudget);
            }
        }
        
        // Event Listeners for user interaction
        
        // Language toggle button
        langToggleBtn.addEventListener('click', () => {
            state.currentLanguage = state.currentLanguage === 'en' ? 'ar' : 'en';
            localStorage.setItem('lang', state.currentLanguage);
            renderUI();
        });

        // Input field for total budget
        inputBudget.addEventListener('input', (e) => {
            const newBudget = parseFloat(e.target.value);
            if (!isNaN(newBudget) && newBudget > 0) {
                state.planData.totalBudget = newBudget;
                calculatePlan();
                renderUI();
            }
        });

        // Input field for target leads
        inputLeads.addEventListener('input', (e) => {
            const desiredLeads = parseFloat(e.target.value);
            const cpl = parseFloat(inputCPL.value);
            if (!isNaN(desiredLeads) && desiredLeads > 0 && !isNaN(cpl) && cpl > 0) {
                state.planData.totalBudget = desiredLeads * cpl;
                inputBudget.value = state.planData.totalBudget.toFixed(0);
                calculatePlan();
                renderUI();
            }
        });

        // Input field for CPL
        inputCPL.addEventListener('input', (e) => {
            const newCPL = parseFloat(e.target.value);
            if (!isNaN(newCPL) && newCPL > 0) {
                state.planData.cpl = newCPL;
                calculatePlan();
                renderUI();
            }
        });

        // Calculate button
        calculateBtn.addEventListener('click', () => {
            calculatePlan();
            renderUI();
            // Show a confirmation message
            Swal.fire({
                icon: 'success',
                title: translations[state.currentLanguage]['calculator.buttonCalculate'] + '!',
                text: translations[state.currentLanguage]['calculator.successMessage'] || 'The plan has been successfully calculated.',
                confirmButtonText: 'OK'
            });
        });

        // Accordion functionality
        function toggleAccordion(contentId) {
            const content = document.getElementById(contentId);
            const arrow = document.querySelector(`#${contentId}`).previousElementSibling.querySelector('svg');

            // Close all other open accordions
            document.querySelectorAll('.accordion-content.open').forEach(item => {
                if (item.id !== contentId) {
                    item.classList.remove('open');
                    item.previousElementSibling.querySelector('svg').classList.remove('rotate-180');
                }
            });

            // Toggle the clicked accordion
            content.classList.toggle('open');
            arrow.classList.toggle('rotate-180');
        }

        // Initialize the page on load
        document.addEventListener('DOMContentLoaded', () => {
            const storedLang = localStorage.getItem('lang');
            if (storedLang && translations[storedLang]) {
                state.currentLanguage = storedLang;
            }
            
            // Initial calculations and UI rendering
            calculatePlan();
            renderUI();
        });

    </script>
</body>
</html>
